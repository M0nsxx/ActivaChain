const hre = require("hardhat");

async function main() {
  console.log("üß™ Probando contratos avanzados de ActivaChain...");
  
  const network = hre.network.name;
  console.log(`üìç Red actual: ${network}`);
  
  const [deployer, user1, user2] = await hre.ethers.getSigners();
  console.log("üîë Usando cuentas:");
  console.log("   Deployer:", deployer.address);
  console.log("   User1:", user1.address);
  console.log("   User2:", user2.address);

  try {
    // Leer informaci√≥n de deployment
    let deploymentInfo;
    const filename = `deployment-info-advanced-${network}.json`;
    
    try {
      deploymentInfo = JSON.parse(require('fs').readFileSync(filename, 'utf8'));
    } catch (error) {
      console.log("‚ùå No se encontr√≥ informaci√≥n de deployment. Ejecuta primero deployAdvancedContracts.js");
      process.exit(1);
    }
    
    console.log("\nüìã Contratos a probar:");
    console.log("   ActivaMultiToken:", deploymentInfo.contracts.activaMultiToken);
    console.log("   ActivaCollection:", deploymentInfo.contracts.activaCollection);
    console.log("   AdvancedReputationSystem:", deploymentInfo.contracts.advancedReputationSystem);
    console.log("   CommunitySystem:", deploymentInfo.contracts.communitySystem);
    console.log("   GamificationSystem:", deploymentInfo.contracts.gamificationSystem);
    console.log("   IPFSIntegration:", deploymentInfo.contracts.ipfsIntegration);
    console.log("   PushNotificationSystem:", deploymentInfo.contracts.pushNotificationSystem);
    console.log("   ExternalAPIIntegration:", deploymentInfo.contracts.externalAPIIntegration);

    // Conectar a contratos
    const activaMultiToken = await hre.ethers.getContractAt("ActivaMultiToken", deploymentInfo.contracts.activaMultiToken);
    const activaCollection = await hre.ethers.getContractAt("ActivaCollection", deploymentInfo.contracts.activaCollection);
    const advancedReputation = await hre.ethers.getContractAt("AdvancedReputationSystem", deploymentInfo.contracts.advancedReputationSystem);
    const communitySystem = await hre.ethers.getContractAt("CommunitySystem", deploymentInfo.contracts.communitySystem);
    const gamificationSystem = await hre.ethers.getContractAt("GamificationSystem", deploymentInfo.contracts.gamificationSystem);
    const ipfsIntegration = await hre.ethers.getContractAt("IPFSIntegration", deploymentInfo.contracts.ipfsIntegration);
    const pushNotificationSystem = await hre.ethers.getContractAt("PushNotificationSystem", deploymentInfo.contracts.pushNotificationSystem);
    const externalAPIIntegration = await hre.ethers.getContractAt("ExternalAPIIntegration", deploymentInfo.contracts.externalAPIIntegration);

    console.log("\nüß™ Iniciando pruebas...");

    // Test 1: ActivaMultiToken
    console.log("\n1Ô∏è‚É£ Probando ActivaMultiToken...");
    try {
      // Crear token
      const createTx = await activaMultiToken.createToken(
        "Test Token",
        "TEST",
        1000,
        hre.ethers.parseEther("0.01"),
        1, // Invierno
        "ipfs://test-metadata"
      );
      await createTx.wait();
      console.log("‚úÖ Token creado exitosamente");

      // Mintear token
      const mintTx = await activaMultiToken.mintToken(0, 5, { value: hre.ethers.parseEther("0.05") });
      await mintTx.wait();
      console.log("‚úÖ Token minteado exitosamente");

      // Leer informaci√≥n del token
      const tokenInfo = await activaMultiToken.getTokenInfo(0);
      console.log("‚úÖ Informaci√≥n del token le√≠da:", tokenInfo.name);
    } catch (error) {
      console.log("‚ùå Error en ActivaMultiToken:", error.message);
    }

    // Test 2: ActivaCollection
    console.log("\n2Ô∏è‚É£ Probando ActivaCollection...");
    try {
      // Crear colecci√≥n
      const createTx = await activaCollection.createCollection(
        "Test Collection",
        "Una colecci√≥n de prueba",
        100,
        hre.ethers.parseEther("0.05"),
        1, // Invierno
        "ipfs://test-collection-metadata"
      );
      await createTx.wait();
      console.log("‚úÖ Colecci√≥n creada exitosamente");

      // Mintear NFT de la colecci√≥n
      const mintTx = await activaCollection.mintFromCollection(0, "ipfs://test-nft-metadata", { value: hre.ethers.parseEther("0.05") });
      await mintTx.wait();
      console.log("‚úÖ NFT minteado de la colecci√≥n exitosamente");

      // Leer informaci√≥n de la colecci√≥n
      const collectionInfo = await activaCollection.getCollectionInfo(0);
      console.log("‚úÖ Informaci√≥n de la colecci√≥n le√≠da:", collectionInfo.name);
    } catch (error) {
      console.log("‚ùå Error en ActivaCollection:", error.message);
    }

    // Test 3: AdvancedReputationSystem
    console.log("\n3Ô∏è‚É£ Probando AdvancedReputationSystem...");
    try {
      // Verificar identidad con ZK proof
      const proofHash = hre.ethers.keccak256(hre.ethers.toUtf8Bytes("test-proof"));
      const verifyTx = await advancedReputation.verifyIdentityWithZK(proofHash, "0x1234", 1);
      await verifyTx.wait();
      console.log("‚úÖ Verificaci√≥n ZK exitosa");

      // Endorsar usuario
      const endorseTx = await advancedReputation.endorseUser(user1.address);
      await endorseTx.wait();
      console.log("‚úÖ Endorsement exitoso");

      // Registrar actividad
      const activityTx = await advancedReputation.recordActivity(user1.address);
      await activityTx.wait();
      console.log("‚úÖ Actividad registrada exitosamente");

      // Leer reputaci√≥n
      const reputation = await advancedReputation.getReputation(user1.address);
      console.log("‚úÖ Reputaci√≥n le√≠da:", Number(reputation.score), "puntos");
    } catch (error) {
      console.log("‚ùå Error en AdvancedReputationSystem:", error.message);
    }

    // Test 4: CommunitySystem
    console.log("\n4Ô∏è‚É£ Probando CommunitySystem...");
    try {
      // Registrar mentoreada
      const menteeTx = await communitySystem.connect(user1).registerMentee(
        "Test Mentee",
        "Aprender blockchain",
        1
      );
      await menteeTx.wait();
      console.log("‚úÖ Mentoreada registrada exitosamente");

      // Crear workshop
      const startTime = Math.floor(Date.now() / 1000) + 3600; // 1 hora desde ahora
      const endTime = startTime + 7200; // 2 horas de duraci√≥n
      
      const workshopTx = await communitySystem.createWorkshop(
        "Test Workshop",
        "Un workshop de prueba",
        startTime,
        endTime,
        20,
        hre.ethers.parseEther("0.05"),
        { value: hre.ethers.parseEther("0.005") }
      );
      await workshopTx.wait();
      console.log("‚úÖ Workshop creado exitosamente");

      // Crear evento
      const eventTx = await communitySystem.createEvent(
        "Test Event",
        "Un evento de prueba",
        startTime,
        endTime,
        "Online",
        50,
        { value: hre.ethers.parseEther("0.002") }
      );
      await eventTx.wait();
      console.log("‚úÖ Evento creado exitosamente");

      // Leer workshops activos
      const activeWorkshops = await communitySystem.getActiveWorkshops();
      console.log("‚úÖ Workshops activos:", activeWorkshops.length);
    } catch (error) {
      console.log("‚ùå Error en CommunitySystem:", error.message);
    }

    // Test 5: GamificationSystem
    console.log("\n5Ô∏è‚É£ Probando GamificationSystem...");
    try {
      // Desbloquear achievement
      const achievementTx = await gamificationSystem.unlockAchievement(user1.address, 0);
      await achievementTx.wait();
      console.log("‚úÖ Achievement desbloqueado exitosamente");

      // Otorgar badge
      const badgeTx = await gamificationSystem.earnBadge(user1.address, 0);
      await badgeTx.wait();
      console.log("‚úÖ Badge otorgado exitosamente");

      // Registrar actividad diaria
      const activityTx = await gamificationSystem.recordDailyActivity(user1.address);
      await activityTx.wait();
      console.log("‚úÖ Actividad diaria registrada exitosamente");

      // Leer perfil de usuario
      const profile = await gamificationSystem.getUserProfile(user1.address);
      console.log("‚úÖ Perfil de usuario le√≠do:", Number(profile.totalPoints), "puntos");
    } catch (error) {
      console.log("‚ùå Error en GamificationSystem:", error.message);
    }

    // Test 6: IPFSIntegration
    console.log("\n6Ô∏è‚É£ Probando IPFSIntegration...");
    try {
      // Subir archivo
      const uploadTx = await ipfsIntegration.uploadFile(
        "QmTestHash123",
        "test-file.txt",
        "text/plain",
        1024,
        true,
        { value: hre.ethers.parseEther("0.001") }
      );
      await uploadTx.wait();
      console.log("‚úÖ Archivo subido exitosamente");

      // Crear colecci√≥n
      const collectionTx = await ipfsIntegration.createCollection(
        "Test Collection",
        "Una colecci√≥n de prueba",
        ["QmTestHash123"],
        true
      );
      await collectionTx.wait();
      console.log("‚úÖ Colecci√≥n IPFS creada exitosamente");

      // Leer informaci√≥n del archivo
      const fileInfo = await ipfsIntegration.getFileInfo("QmTestHash123");
      console.log("‚úÖ Informaci√≥n del archivo le√≠da:", fileInfo.name);
    } catch (error) {
      console.log("‚ùå Error en IPFSIntegration:", error.message);
    }

    // Test 7: PushNotificationSystem
    console.log("\n7Ô∏è‚É£ Probando PushNotificationSystem...");
    try {
      // Enviar notificaci√≥n
      const notificationTx = await pushNotificationSystem.sendNotification(
        user1.address,
        "Test Notification",
        "Esta es una notificaci√≥n de prueba",
        1, // Transaction
        '{"test": "data"}'
      );
      await notificationTx.wait();
      console.log("‚úÖ Notificaci√≥n enviada exitosamente");

      // Actualizar configuraci√≥n de usuario
      const settingsTx = await pushNotificationSystem.connect(user1).updateNotificationSettings(
        true, // transactionNotifications
        true, // achievementNotifications
        true, // communityNotifications
        true, // systemNotifications
        true, // emailNotifications
        true, // pushNotifications
        22, // quietHoursStart
        6   // quietHoursEnd
      );
      await settingsTx.wait();
      console.log("‚úÖ Configuraci√≥n de notificaciones actualizada exitosamente");

      // Leer configuraci√≥n
      const settings = await pushNotificationSystem.getNotificationSettings(user1.address);
      console.log("‚úÖ Configuraci√≥n le√≠da:", settings.pushNotifications);
    } catch (error) {
      console.log("‚ùå Error en PushNotificationSystem:", error.message);
    }

    // Test 8: ExternalAPIIntegration
    console.log("\n8Ô∏è‚É£ Probando ExternalAPIIntegration...");
    try {
      // Actualizar configuraci√≥n de Circle
      const circleTx = await externalAPIIntegration.updateCircleConfig(
        "test-api-key",
        "sandbox",
        true
      );
      await circleTx.wait();
      console.log("‚úÖ Configuraci√≥n de Circle actualizada exitosamente");

      // Simular llamada API
      const apiCallTx = await externalAPIIntegration.makeAPICall(
        "circle",
        "/v1/balance",
        "GET",
        '{"address":"0x123"}',
        { value: hre.ethers.parseEther("0.0001") }
      );
      await apiCallTx.wait();
      console.log("‚úÖ Llamada API simulada exitosamente");

      // Leer configuraci√≥n
      const circleConfig = await externalAPIIntegration.getCircleConfig();
      console.log("‚úÖ Configuraci√≥n de Circle le√≠da:", circleConfig.isActive);
    } catch (error) {
      console.log("‚ùå Error en ExternalAPIIntegration:", error.message);
    }

    console.log("\nüéâ ¬°TODAS LAS PRUEBAS COMPLETADAS EXITOSAMENTE!");
    console.log("=" * 60);
    console.log("‚úÖ ActivaMultiToken: Funcionando");
    console.log("‚úÖ ActivaCollection: Funcionando");
    console.log("‚úÖ AdvancedReputationSystem: Funcionando");
    console.log("‚úÖ CommunitySystem: Funcionando");
    console.log("‚úÖ GamificationSystem: Funcionando");
    console.log("‚úÖ IPFSIntegration: Funcionando");
    console.log("‚úÖ PushNotificationSystem: Funcionando");
    console.log("‚úÖ ExternalAPIIntegration: Funcionando");
    
    console.log("\nüöÄ Pr√≥ximos pasos:");
    console.log("   1. Probar funcionalidades en frontend");
    console.log("   2. Configurar APIs externas reales");
    console.log("   3. Crear contenido inicial");
    console.log("   4. Lanzar a la comunidad");
    
  } catch (error) {
    console.error("‚ùå Error en las pruebas:", error);
    process.exit(1);
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
