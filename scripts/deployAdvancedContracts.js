const hre = require("hardhat");
const fs = require('fs');

async function main() {
  console.log("üöÄ Desplegando contratos avanzados de ActivaChain...");
  
  const network = hre.network.name;
  console.log(`üìç Red actual: ${network}`);
  
  const [deployer] = await hre.ethers.getSigners();
  console.log("üîë Usando cuenta:", deployer.address);
  console.log("üí∞ Balance:", hre.ethers.formatEther(await hre.ethers.provider.getBalance(deployer.address)), "ETH");

  try {
    const deploymentInfo = {
      network: network,
      chainId: hre.network.config.chainId,
      deployer: deployer.address,
      timestamp: new Date().toISOString(),
      contracts: {}
    };

    // 1. Desplegar ActivaMultiToken (ERC1155)
    console.log("\n1Ô∏è‚É£ Desplegando ActivaMultiToken...");
    const ActivaMultiToken = await hre.ethers.getContractFactory("ActivaMultiToken");
    const activaMultiToken = await ActivaMultiToken.deploy();
    await activaMultiToken.waitForDeployment();
    const multiTokenAddress = await activaMultiToken.getAddress();
    console.log("‚úÖ ActivaMultiToken desplegado en:", multiTokenAddress);
    deploymentInfo.contracts.activaMultiToken = multiTokenAddress;

    // 2. Desplegar ActivaCollection (ERC721)
    console.log("\n2Ô∏è‚É£ Desplegando ActivaCollection...");
    const ActivaCollection = await hre.ethers.getContractFactory("ActivaCollection");
    const activaCollection = await ActivaCollection.deploy();
    await activaCollection.waitForDeployment();
    const collectionAddress = await activaCollection.getAddress();
    console.log("‚úÖ ActivaCollection desplegado en:", collectionAddress);
    deploymentInfo.contracts.activaCollection = collectionAddress;

    // 3. Desplegar AdvancedReputationSystem
    console.log("\n3Ô∏è‚É£ Desplegando AdvancedReputationSystem...");
    const AdvancedReputationSystem = await hre.ethers.getContractFactory("AdvancedReputationSystem");
    const advancedReputation = await AdvancedReputationSystem.deploy();
    await advancedReputation.waitForDeployment();
    const reputationAddress = await advancedReputation.getAddress();
    console.log("‚úÖ AdvancedReputationSystem desplegado en:", reputationAddress);
    deploymentInfo.contracts.advancedReputation = reputationAddress;

    // 4. Desplegar CommunitySystem
    console.log("\n4Ô∏è‚É£ Desplegando CommunitySystem...");
    const CommunitySystem = await hre.ethers.getContractFactory("CommunitySystem");
    const communitySystem = await CommunitySystem.deploy();
    await communitySystem.waitForDeployment();
    const communityAddress = await communitySystem.getAddress();
    console.log("‚úÖ CommunitySystem desplegado en:", communityAddress);
    deploymentInfo.contracts.communitySystem = communityAddress;

    // 5. Desplegar GamificationSystem
    console.log("\n5Ô∏è‚É£ Desplegando GamificationSystem...");
    const GamificationSystem = await hre.ethers.getContractFactory("GamificationSystem");
    const gamificationSystem = await GamificationSystem.deploy();
    await gamificationSystem.waitForDeployment();
    const gamificationAddress = await gamificationSystem.getAddress();
    console.log("‚úÖ GamificationSystem desplegado en:", gamificationAddress);
    deploymentInfo.contracts.gamificationSystem = gamificationAddress;

    // 6. Desplegar IPFSIntegration
    console.log("\n6Ô∏è‚É£ Desplegando IPFSIntegration...");
    const IPFSIntegration = await hre.ethers.getContractFactory("IPFSIntegration");
    const ipfsIntegration = await IPFSIntegration.deploy();
    await ipfsIntegration.waitForDeployment();
    const ipfsAddress = await ipfsIntegration.getAddress();
    console.log("‚úÖ IPFSIntegration desplegado en:", ipfsAddress);
    deploymentInfo.contracts.ipfsIntegration = ipfsAddress;

    // 7. Desplegar PushNotificationSystem
    console.log("\n7Ô∏è‚É£ Desplegando PushNotificationSystem...");
    const PushNotificationSystem = await hre.ethers.getContractFactory("PushNotificationSystem");
    const pushNotificationSystem = await PushNotificationSystem.deploy();
    await pushNotificationSystem.waitForDeployment();
    const pushAddress = await pushNotificationSystem.getAddress();
    console.log("‚úÖ PushNotificationSystem desplegado en:", pushAddress);
    deploymentInfo.contracts.pushNotificationSystem = pushAddress;

    // 8. Desplegar ExternalAPIIntegration
    console.log("\n8Ô∏è‚É£ Desplegando ExternalAPIIntegration...");
    const ExternalAPIIntegration = await hre.ethers.getContractFactory("ExternalAPIIntegration");
    const externalAPIIntegration = await ExternalAPIIntegration.deploy();
    await externalAPIIntegration.waitForDeployment();
    const apiAddress = await externalAPIIntegration.getAddress();
    console.log("‚úÖ ExternalAPIIntegration desplegado en:", apiAddress);
    deploymentInfo.contracts.externalAPIIntegration = apiAddress;

    // 9. Configurar permisos iniciales
    console.log("\n9Ô∏è‚É£ Configurando permisos iniciales...");
    
    // Dar reputaci√≥n inicial al deployer
    await advancedReputation.updateReputation(deployer.address, 1000, true);
    console.log("‚úÖ Reputaci√≥n inicial otorgada al deployer");

    // Registrar al deployer como mentor
    await communitySystem.registerMentor(
      "Deployer",
      "Desarrollador principal de ActivaChain",
      ["Blockchain", "Smart Contracts", "DeFi"],
      5,
      hre.ethers.parseEther("0.1"),
      { value: hre.ethers.parseEther("0.01") }
    );
    console.log("‚úÖ Deployer registrado como mentor");

    // 10. Crear algunos tokens y colecciones de ejemplo
    console.log("\nüîü Creando tokens y colecciones de ejemplo...");
    
    // Crear token de invierno
    const winterTokenId = await activaMultiToken.createToken(
      "Flores de Invierno",
      "WINTER",
      1000,
      hre.ethers.parseEther("0.01"),
      1, // Invierno
      "ipfs://winter-flowers-metadata"
    );
    console.log("‚úÖ Token de invierno creado con ID:", Number(winterTokenId));

    // Crear colecci√≥n de primavera
    const springCollectionId = await activaCollection.createCollection(
      "Hongos M√°gicos de Primavera",
      "Una colecci√≥n √∫nica de hongos m√°gicos para la temporada de primavera",
      100,
      hre.ethers.parseEther("0.05"),
      2, // Primavera
      "ipfs://spring-mushrooms-metadata"
    );
    console.log("‚úÖ Colecci√≥n de primavera creada con ID:", Number(springCollectionId));

    // 11. Guardar informaci√≥n de deployment
    const filename = `deployment-info-advanced-${network}.json`;
    fs.writeFileSync(filename, JSON.stringify(deploymentInfo, null, 2));
    console.log(`‚úÖ Informaci√≥n de deployment guardada en ${filename}`);

    // 12. Actualizar useContracts.ts
    console.log("\n1Ô∏è‚É£1Ô∏è‚É£ Actualizando frontend...");
    const useContractsPath = 'frontend/app/lib/useContracts.ts';
    let useContractsContent = fs.readFileSync(useContractsPath, 'utf8');
    
    // Agregar nuevas direcciones
    const newAddresses = `
        activaMultiToken: '${multiTokenAddress}' as \`0x\${string}\`,
        activaCollection: '${collectionAddress}' as \`0x\${string}\`,
        advancedReputation: '${reputationAddress}' as \`0x\${string}\`,
        communitySystem: '${communityAddress}' as \`0x\${string}\`,
        gamificationSystem: '${gamificationAddress}' as \`0x\${string}\`,
        ipfsIntegration: '${ipfsAddress}' as \`0x\${string}\`,
        pushNotificationSystem: '${pushAddress}' as \`0x\${string}\`,
        externalAPIIntegration: '${apiAddress}' as \`0x\${string}\`,`;
    
    // Insertar despu√©s de las direcciones existentes
    useContractsContent = useContractsContent.replace(
      /activaNFT: '0x0000000000000000000000000000000000000000' as `0x\${string}\`,/,
      `activaNFT: '0x0000000000000000000000000000000000000000' as \`0x\${string}\`,${newAddresses}`
    );
    
    fs.writeFileSync(useContractsPath, useContractsContent);
    console.log("‚úÖ Frontend actualizado con nuevas direcciones");

    console.log("\nüéâ ¬°TODOS LOS CONTRATOS AVANZADOS DESPLEGADOS EXITOSAMENTE!");
    console.log("=" * 80);
    console.log(`üìç Red: ${network}`);
    console.log(`üîó ActivaMultiToken: ${multiTokenAddress}`);
    console.log(`üîó ActivaCollection: ${collectionAddress}`);
    console.log(`üîó AdvancedReputationSystem: ${reputationAddress}`);
    console.log(`üîó CommunitySystem: ${communityAddress}`);
    console.log(`üîó GamificationSystem: ${gamificationAddress}`);
    console.log(`üîó IPFSIntegration: ${ipfsAddress}`);
    console.log(`üîó PushNotificationSystem: ${pushAddress}`);
    console.log(`üîó ExternalAPIIntegration: ${apiAddress}`);
    
    console.log("\nüåê Verificar en explorer:");
    if (network === 'sepolia') {
      console.log(`   ActivaMultiToken: https://sepolia.etherscan.io/address/${multiTokenAddress}`);
      console.log(`   ActivaCollection: https://sepolia.etherscan.io/address/${collectionAddress}`);
      console.log(`   AdvancedReputationSystem: https://sepolia.etherscan.io/address/${reputationAddress}`);
      console.log(`   CommunitySystem: https://sepolia.etherscan.io/address/${communityAddress}`);
      console.log(`   GamificationSystem: https://sepolia.etherscan.io/address/${gamificationAddress}`);
      console.log(`   IPFSIntegration: https://sepolia.etherscan.io/address/${ipfsAddress}`);
      console.log(`   PushNotificationSystem: https://sepolia.etherscan.io/address/${pushAddress}`);
      console.log(`   ExternalAPIIntegration: https://sepolia.etherscan.io/address/${apiAddress}`);
    } else if (network === 'arbitrumSepolia') {
      console.log(`   ActivaMultiToken: https://sepolia.arbiscan.io/address/${multiTokenAddress}`);
      console.log(`   ActivaCollection: https://sepolia.arbiscan.io/address/${collectionAddress}`);
      console.log(`   AdvancedReputationSystem: https://sepolia.arbiscan.io/address/${reputationAddress}`);
      console.log(`   CommunitySystem: https://sepolia.arbiscan.io/address/${communityAddress}`);
      console.log(`   GamificationSystem: https://sepolia.arbiscan.io/address/${gamificationAddress}`);
      console.log(`   IPFSIntegration: https://sepolia.arbiscan.io/address/${ipfsAddress}`);
      console.log(`   PushNotificationSystem: https://sepolia.arbiscan.io/address/${pushAddress}`);
      console.log(`   ExternalAPIIntegration: https://sepolia.arbiscan.io/address/${apiAddress}`);
    }
    
    console.log("\nüöÄ Pr√≥ximos pasos:");
    console.log("   1. Verificar contratos en explorer");
    console.log("   2. Probar funcionalidades en frontend");
    console.log("   3. Configurar APIs externas");
    console.log("   4. Crear contenido inicial");
    console.log("   5. Lanzar a la comunidad");
    
  } catch (error) {
    console.error("‚ùå Error desplegando contratos avanzados:", error);
    process.exit(1);
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
